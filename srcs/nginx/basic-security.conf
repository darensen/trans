# Basic Security Configuration for Nginx
# This provides WAF-like functionality using native nginx modules

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=200r/m;
limit_req_zone $binary_remote_addr zone=general:10m rate=300r/m;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_zone $server_name zone=perserver:10m;

# Map for blocking malicious requests
map $args $malicious_request {
    default 0;
    "~*(\<|%3C).*script.*(\>|%3E)" 1;
    "~*(\<|%3C).*iframe.*(\>|%3E)" 1;
    "~*(\<|%3C).*object.*(\>|%3E)" 1;
    "~*(\<|%3C).*embed.*(\>|%3E)" 1;
    "~*(\<|%3C).*marquee.*(\>|%3E)" 1;
    "~*(\<|%3C).*link.*(\>|%3E)" 1;
    "~*(union|select|insert|delete|update|drop|create|alter|exec)" 1;
    "~*(\||;|\`)" 1;
}

# Map for blocking malicious URI
map $uri $malicious_uri {
    default 0;
    "~*(\<|%3C).*script.*(\>|%3E)" 1;
    "~*(\<|%3C).*iframe.*(\>|%3E)" 1;
    "~*(\<|%3C).*object.*(\>|%3E)" 1;
    "~*(\||;|\`)" 1;
    "~*/\.\." 1;
    "~*\.(sql|bak|inc|log|sh)$" 1;
}

# Map for blocking malicious request body
map $request_body $malicious_body {
    default 0;
    "~*(\<|%3C).*script.*(\>|%3E)" 1;
    "~*(\<|%3C).*iframe.*(\>|%3E)" 1;
    "~*(\<|%3C).*object.*(\>|%3E)" 1;
    "~*(union|select|insert|delete|update|drop|create|alter|exec)" 1;
    "~*(\||;|\`)" 1;
}
