# Charge le module ModSecurity (notre image le fournit)
load_module modules/ngx_http_modsecurity_module.so;

events {
  worker_connections 1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # Include basic security configuration (rate-limit, limit_conn, maps)
  include /etc/nginx/modsec/basic-security.conf;

  # Security headers (garde leur CSP globale UNIQUE)
  add_header X-Frame-Options DENY always;
  add_header X-Content-Type-Options nosniff always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  # DEV : connect-src autorise wss: et ws: ; en PROD, retire "ws:" pour forcer WSS.
  add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data:; connect-src 'self' wss: ws:;" always;

  # Hide nginx version
  server_tokens off;

  # Helper WebSocket
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  include /etc/nginx/conf.d/*.conf;
}
